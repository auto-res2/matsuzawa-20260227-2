name: "Run Diagram Generator"
run-name: "ðŸ¤– Diagram Generator"

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name (e.g., main)'
        required: true
        default: 'main'
      diagram_description:
        description: 'Description of the diagram to generate (optional; if empty, uses default)'
        required: false
        default: 'Generate 1-2 publication-quality conceptual diagrams for a research paper (e.g., methodology overview, system architecture). Diagrams should be suitable for academic publication with clear labels, minimal color, and professional style.'
      output_dir:
        description: 'Directory to save generated diagrams'
        required: false
        default: '.research/diagrams'
      github_actions_agent:
        description: 'AI agent tool to use (claude_code or open_code)'
        required: true
        type: choice
        options:
          - claude_code
          - open_code
        default: 'claude_code'
      model_name:
        description: 'Model to use (for OpenCode: openrouter/openai/gpt-5-nano, for Claude Code: sonnet/opus/haiku)'
        required: true
        default: 'sonnet'
      prompt_path:
        description: 'Path to the prompt template file'
        required: false
        default: '.github/prompts/run_diagram_generator.md'

permissions:
  id-token: write
  contents: write
  actions: write

defaults:
  run:
    shell: bash

env:
  OUTPUT_DIR: ${{ github.event.inputs.output_dir }}

jobs:
  generate-diagrams:
    name: Generate Diagrams
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}

      - name: Create MCP config for PaperBanana
        run: |
          cat > /tmp/mcp-config.json <<'MCPEOF'
          {
            "mcpServers": {
              "paperbanana": {
                "command": "uvx",
                "args": ["--from", "paperbanana[mcp] @ git+https://github.com/genga6/paperbanana.git@fix/issue-58-mcp-generate-diagram-returns-jpeg-data-with-image-png-media-type", "paperbanana-mcp"],
                "env": {
                  "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
                  "OPENAI_BASE_URL": "${{ secrets.OPENAI_BASE_URL }}",
                  "GOOGLE_API_KEY": "${{ secrets.GEMINI_API_KEY }}"
                }
              }
            }
          }
          MCPEOF
          # Remove leading whitespace from each line (heredoc preserves indentation)
          sed -i 's/^[[:space:]]*//' /tmp/mcp-config.json
          echo "MCP config created at /tmp/mcp-config.json"

      - name: Build prompt
        id: build-prompt
        env:
          PROMPT_PATH: ${{ github.event.inputs.prompt_path }}
          DIAGRAM_DESCRIPTION: ${{ github.event.inputs.diagram_description }}
        run: |
          set -e
          if [ ! -f "$PROMPT_PATH" ]; then
            echo "::error::Prompt file not found: $PROMPT_PATH"
            exit 1
          fi

          PROMPT_FILE="/tmp/diagram_generator_prompt.txt"
          {
            cat "$PROMPT_PATH"
            echo ""
            echo "DIAGRAM_DESCRIPTION: $DIAGRAM_DESCRIPTION"
            echo "OUTPUT_DIR: $OUTPUT_DIR"
          } > "$PROMPT_FILE"

          echo "prompt_file=$PROMPT_FILE" >> "$GITHUB_OUTPUT"
          echo "Prompt saved to: $PROMPT_FILE ($(wc -c < "$PROMPT_FILE") bytes)"

      - name: Run Claude Code for diagram generation
        if: github.event.inputs.github_actions_agent == 'claude_code'
        uses: ./.github/actions/run-claude-code
        with:
          prompt_file: ${{ steps.build-prompt.outputs.prompt_file }}
          model_name: ${{ github.event.inputs.model_name }}
          mcp_config: /tmp/mcp-config.json
          timeout_minutes: '30'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Run OpenCode for diagram generation
        if: github.event.inputs.github_actions_agent == 'open_code'
        uses: ./.github/actions/run-open-code
        with:
          prompt_file: ${{ steps.build-prompt.outputs.prompt_file }}
          model_name: ${{ github.event.inputs.model_name }}
          mcp_config: /tmp/mcp-config.json
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Convert images to PDF
        run: |
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "No output directory found, skipping conversion"
            exit 0
          fi
          if ! command -v convert &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y imagemagick
          fi
          find "$OUTPUT_DIR" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) | while read -r img; do
            pdf="${img%.*}.pdf"
            echo "Converting $img -> $pdf"
            convert "$img" "$pdf" && rm "$img"
          done

      - name: Check generated diagrams
        id: check-diagrams
        run: |
          if [ -d "$OUTPUT_DIR" ] && find "$OUTPUT_DIR" -type f -name "*.pdf" | read; then
            echo "Diagrams found in $OUTPUT_DIR"
            echo "has_diagrams=true" >> "$GITHUB_OUTPUT"
          else
            echo "No diagrams found in $OUTPUT_DIR"
            echo "has_diagrams=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload diagrams as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagrams-${{ github.run_id }}
          path: ${{ env.OUTPUT_DIR }}

      - name: Commit and push generated diagrams
        if: steps.check-diagrams.outputs.has_diagrams == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git add "$OUTPUT_DIR"

          if ! git diff --staged --quiet; then
            git commit -m "[CI] Generate diagrams using ${{ github.event.inputs.github_actions_agent }}"
            git checkout -- .
            for i in {1..5}; do
              git pull --rebase -X theirs origin ${{ github.event.inputs.branch_name }}
              git push && break
              echo "Push failed on attempt $i. Retrying in $((2**i)) seconds..."
              sleep $((2**i))
            done
          else
            echo "No diagram changes to commit."
          fi
